@using BlogSystem.Web.Areas.Posts.Models
@using Microsoft.AspNet.Identity
@using BlogSystem.Web.Helpers

@model PostViewModel

@{
    var pagingUpdateTarget = "p" + @Model.Id + "pc";
    var commentFormId = "commentFormId";
    var commentLoadingId = "commentLoadingId";
}

<div class="row" id="@Model.Id">
    @if (User.Identity.IsAuthenticated)
    {
        var postVotingId = "postVoting" + @Model.Id;
        var feedBackMessageId = "feedbackMessage" + @Model.Id;

        <div id="@feedBackMessageId"></div>
        <div class="col-sm-1">
            <button type="button" class="btn btn-default btn-sm" data-toggle="modal" data-target="#layoutModal">
                @Ajax.ActionLink(" ", "VotePost", "Home", new { id = @Model.Id, vote = true, area = "Likes" },
                        new AjaxOptions
                        {
                            InsertionMode = InsertionMode.Replace,
                            UpdateTargetId = "modalContentElement",
                            LoadingElementId = "modalLoadingElement",
                            OnBegin = "$('#modalContentElement').empty()",
                            HttpMethod = "Post",
                        },
                        htmlAttributes: new { @class = "glyphicon glyphicon-thumbs-up", Title = "Vote Up" })
            </button>
            <button type="button" class="btn btn-default btn-sm" data-toggle="modal" data-target="#layoutModal">
                @Ajax.ActionLink(" ", "VotePost", "Home", new { id = @Model.Id, vote = false, area = "Likes" },
                        new AjaxOptions
                        {
                            InsertionMode = InsertionMode.Replace,
                            UpdateTargetId = "modalContentElement",
                            LoadingElementId = "modalLoadingElement",
                            OnBegin = "$('#modalContentElement').empty()",
                            HttpMethod = "Post",
                        },
                     htmlAttributes: new { @class = "glyphicon glyphicon-thumbs-down", Title = "Vote Down" })
            </button>
            @LoadingElementHelper.ProgressBar(id: @postVotingId, width: 75, alertType: "info", maxValue: 10)
        </div>
    }
    <div class="col-sm-11">
        <h4>
            @*@Model.Title*@
            @Ajax.ActionLink(@Model.Title, "DisplayPost", "Home", new { id = @Model.Id, area = "Posts" },
                        new AjaxOptions
                        {
                            InsertionMode = InsertionMode.Replace,
                            UpdateTargetId = "postsShown",
                            LoadingElementId = "loading",
                            HttpMethod = "Get",
                        },
                        new { Title = "Read Post" })
        </h4>

        <span class="label label-primary">@Model.Category</span>
        <span class="label label-success">@Model.Author</span>
        <span class="label label-info">@Model.CreatedOn</span>
        @{
            var likesCountId = "likes" + @Model.Id;
            var commentsCountId = "comments" + @Model.Id;
            var labelClass = "label-success";
        }
        @if (@Model.Likes < 0)
        {
            labelClass = "label-danger";
        }
        <span class="label @labelClass">Likes <span id="@likesCountId">@Model.Likes</span></span>
        @{
            var postCommentsId = "post" + @Model.Id;
        }
        @if (@Model.CommentsCount > 0)
        {
            <span class="label label-info">
                <span id="@commentsCountId">
                    @Ajax.ActionLink("Comments " + @Model.CommentsCount, "ViewComments", "Comments", new { PostId = @Model.Id, area = "Posts" },
                        new AjaxOptions
                        {
                            InsertionMode = InsertionMode.Replace,
                            UpdateTargetId = @pagingUpdateTarget,
                            LoadingElementId = @postCommentsId,
                            HttpMethod = "Get",
                        },
                        new { Title = "View Comments" })
                </span>
            </span>
        }
        else
        {
            <span class="label label-info">
                <span id="@commentsCountId">Comments @Model.CommentsCount</span>
            </span>
        }

        @if (User.Identity.IsAuthenticated && @Model.Author == User.Identity.Name)
        {
            @Ajax.ActionLink("Delete", "DeletePost", "Home", new { id = @Model.Id, area = "Posts" },
        new AjaxOptions
        {
            InsertionMode = InsertionMode.Replace,
            UpdateTargetId = @Model.Id.ToString(),
            LoadingElementId = "loading",
            Confirm = "Delete?",
            HttpMethod = "Post",
        },
        htmlAttributes: new { @class = "glyphicon glyphicon-trash" })
        }

        <h5>@Model.Content</h5>
        @if (User.Identity.IsAuthenticated)
        {
            <div>
                @{
            var commentLinkIcon = "<span class='glyphicon glyphicon-comment' aria-hidden='true'></span>";
            if (@Model.CommentsCount == 0)
            {
                commentLinkIcon = "First one to comment..." + commentLinkIcon;
            }
                }

                @LoadingElementHelper.ProgressBar(id: @commentLoadingId, width: 90, alertType: "info")

                <div>
                    @Ajax.RawActionLink(commentLinkIcon, "GetCommentForm", "Comments", new { PostId = @Model.Id, area = "Posts" },
                        new AjaxOptions
                     {
                         InsertionMode = InsertionMode.Replace,
                         UpdateTargetId = "modalContentElement",
                         LoadingElementId = "modalLoadingElement",
                         OnBegin = "$('#modalContentElement').empty()",
                         HttpMethod = "Post",
                     },
                     new { Title = "Comment", data_toggle = "modal", data_target = "#layoutModal" })
                </div>
            </div>
        }
    </div>
</div>

@LoadingElementHelper.ProgressBar(id: @postCommentsId, width: 90, alertType: "info")

@if (User.Identity.IsAuthenticated)
{
    <div id="@commentFormId">

    </div>
}

<ul class="media-list">
    <li class="media" id="@pagingUpdateTarget">
    </li>
</ul>